@model IEnumerable<SchroniskaTurystyczne.Models.Shelter>

@{
    ViewData["Title"] = "Dostępne Schroniska";
}

<div class="search-bar">
    <form asp-action="Index" asp-controller="Shelters" method="get">
        <label for="search-term">Szukaj schroniska:</label>
        <input type="text" id="search-term" name="searchTerm" placeholder="Wpisz nazwę lub miasto...">
        <button type="submit">Szukaj</button>
    </form>
</div>

<div class="shelter-list">
    @foreach (var shelter in Model)
    {
        <div class="shelter-container">
            <!-- Kolumna informacyjna -->
            <div class="shelter-info">
                <h3>@shelter.Name</h3>
                <p><strong>Wystawiający:</strong> @shelter.Exhibitor.FirstName @shelter.Exhibitor.LastName</p>

                <p class="shelter-description">
                    <strong>Opis:</strong> @shelter.Description
                </p>
                <p class="shelter-description">
                    <strong>Lokalizacja:</strong> @shelter.Country, @shelter.City
                </p>

                <!--@if (shelter.Rooms != null && shelter.Rooms.Any())
                {
                        <h4>Pokoje:</h4>
                        <ul>
                        @foreach (var room in shelter.Rooms)
                        {
                        <li><strong>Nazwa:</strong> @room.Name, <strong>Pojemność:</strong> @room.Capacity</li>
                            @if (room.Facilities != null && room.Facilities.Any())
                            {
                                 <p><strong>Udogodnienia:</strong>@string.Join(", ", room.Facilities.Select(fac => fac.Name))</p>
                            }
                        }
                        </ul>
                }-->

                @if (shelter.Tags != null && shelter.Tags.Any())
                {
                    <p><strong>Tagi:</strong> @string.Join(", ", shelter.Tags.Select(tag => tag.Name))</p>
                }
            </div>

            <!-- Kolumna ze zdjęciem -->
            <div class="shelter-photo">
                @if (shelter.Photos != null && shelter.Photos.Any())
                {
                    <img src="data:image;base64,@Convert.ToBase64String(shelter.Photos.First().PhotoData)" alt="@shelter.Photos.First().Name" />
                }
            </div>

            <div class="shelter-actions">
                <!--<button style="background-color:darkcyan" onclick="openMap(@shelter.LocationLat, @shelter.LocationLon, '@shelter.Id')">Pokaż na mapie</button>-->
                <a style="background-color:darkcyan" asp-action="MapView" asp-controller="Shelters" asp-route-id="@shelter.Id">Pokaż na mapie</a>
                <a style="background-color:aquamarine; color: black" asp-action="Booking" asp-controller="Shelters" asp-route-id="@shelter.Id">Rezerwuj</a>
            </div>
        </div>
        <!-- Mapa schroniska -->
        <div style="column-span: all; width: 100%; height: 400px; display:none;" id="map-@shelter.Id"></div>
    }
</div>

<script>

    const API_KEY = 'EqrphcGjSSf6pg5L1FXub1nmdOe9HzC_FV00UDqrve4';

    let activeMap = null;
    let activeMapDiv = null;
    let activeMapShelterId = null;

    function openMap(lat, lon, shelterId) {

        if (activeMapDiv && activeMapShelterId === shelterId) {
            activeMapDiv.style.display = 'none';
            activeMap.remove();
            activeMap = null;
            activeMapDiv = null;
            return;
        }
        else if (activeMapDiv)
        {
            activeMapDiv.style.display = 'none';
            activeMap.remove();
            activeMap = null;
            activeMapDiv = null;
        }

        activeMapShelterId = shelterId;

        const mapDiv = document.getElementById('map-' + shelterId);

        mapDiv.style.display = 'block';

        const map = L.map('map-' + shelterId).setView([lat, lon], 16);

        L.tileLayer(`https://api.mapy.cz/v1/maptiles/basic/256/{z}/{x}/{y}?apikey=${API_KEY}&lang=pl`, {
            minZoom: 0,
            maxZoom: 19,
            attribution: '<a href="https://api.mapy.cz/copyright" target="_blank">&copy; Seznam.cz a.s. a další</a>',
        }).addTo(map);

        L.marker([lat, lon]).addTo(map);

        const LogoControl = L.Control.extend({
            options: {
                position: 'bottomleft',
            },

            onAdd: function (map) {
                const container = L.DomUtil.create('div');
                const link = L.DomUtil.create('a', '', container);

                link.setAttribute('href', 'http://mapy.cz/');
                link.setAttribute('target', '_blank');
                link.innerHTML = '<img src="https://api.mapy.cz/img/api/logo.svg" />';
                L.DomEvent.disableClickPropagation(link);

                return container;
            },
        });

        new LogoControl().addTo(map);

        activeMap = map;
        activeMapDiv = mapDiv;
    };
</script>