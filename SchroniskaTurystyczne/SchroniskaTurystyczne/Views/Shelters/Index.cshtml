@model IEnumerable<SchroniskaTurystyczne.Models.Shelter>

@{
    ViewData["Title"] = "Dostępne Schroniska";
}

<h2 style="font-size: 30px">@ViewData["Title"]</h2>

<div class="shelter-list">
    @foreach (var shelter in Model)
    {
        <div>
            <h3 style="color: grey; font-size: 20px; margin-top: 30px">@shelter.Name</h3>
            <p><strong>Opis:</strong> @shelter.Description</p>
            <p><strong>Ocena:</strong> @shelter.Rating</p>
            <p><strong>Lokalizacja:</strong> @shelter.LocationLat, @shelter.LocationLon</p>

            @if (shelter.Photos.Any())
            {
                <div>
                    <img src=@Url.Content("~/Images/" + shelter.Photos.First().Name + ".png") alt="@shelter.Photos.First().Name" style="width:200px;" />
                </div>
            }

            <button onclick="openMap(@shelter.LocationLat, @shelter.LocationLon, '@shelter.Id')">Pokaż mapę</button>
            <button >Rezerwuj</button>

            <div style="width: 100%; height: 400px; display:none;" id="map-@shelter.Id"></div>
        </div>
    }
</div>

<script>

    const API_KEY = 'EqrphcGjSSf6pg5L1FXub1nmdOe9HzC_FV00UDqrve4';

    let activeMap = null;
    let activeMapDiv = null;

    function openMap(lat, lon, shelterId) {

        if (activeMapDiv) {
            activeMapDiv.style.display = 'none';
            activeMap.remove();
            activeMap = null;
            activeMapDiv = null;
        }

        const mapDiv = document.getElementById('map-' + shelterId);

        mapDiv.style.display = 'block';

        const map = L.map('map-' + shelterId).setView([lat, lon], 16);

        L.tileLayer(`https://api.mapy.cz/v1/maptiles/basic/256/{z}/{x}/{y}?apikey=${API_KEY}&lang=pl`, {
            minZoom: 0,
            maxZoom: 19,
            attribution: '<a href="https://api.mapy.cz/copyright" target="_blank">&copy; Seznam.cz a.s. a další</a>',
        }).addTo(map);

        L.marker([lat, lon]).addTo(map);

        const LogoControl = L.Control.extend({
            options: {
                position: 'bottomleft',
            },

            onAdd: function (map) {
                const container = L.DomUtil.create('div');
                const link = L.DomUtil.create('a', '', container);

                link.setAttribute('href', 'http://mapy.cz/');
                link.setAttribute('target', '_blank');
                link.innerHTML = '<img src="https://api.mapy.cz/img/api/logo.svg" />';
                L.DomEvent.disableClickPropagation(link);

                return container;
            },
        });

        new LogoControl().addTo(map);

        activeMap = map;
        activeMapDiv = mapDiv;
    };
</script>