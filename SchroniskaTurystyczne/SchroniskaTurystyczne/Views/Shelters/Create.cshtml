<!-- Formularz schroniska -->
@model SchroniskaTurystyczne.Models.Shelter

@{
    ViewData["Title"] = "Dodaj Schronisko";
}

<h2>@ViewData["Title"]</h2>

<div id="map" style="height: 400px; margin-bottom: 20px;"></div>

<form asp-action="Create" method="post" enctype="multipart/form-data" class="mb-5">

    <div class="form-group">
        <label asp-for="Name" class="control-label">Nazwa Schroniska</label>
        <input asp-for="Name" class="form-control" />
        <span asp-validation-for="Name" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Description" class="control-label">Opis</label>
        <textarea asp-for="Description" class="form-control"></textarea>
        <span asp-validation-for="Description" class="text-danger"></span>
    </div>

    <h4>Adres Schroniska</h4>
    <div class="form-group">
        <label asp-for="Country" class="control-label">Kraj</label>
        <input asp-for="Country" class="form-control" />
        <span asp-validation-for="Country" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="City" class="control-label">Miasto</label>
        <input asp-for="City" class="form-control" />
        <span asp-validation-for="City" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="Street" class="control-label">Ulica</label>
        <input asp-for="Street" class="form-control" />
        <span asp-validation-for="Street" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="StreetNumber" class="control-label">Numer ulicy</label>
        <input asp-for="StreetNumber" class="form-control" />
        <span asp-validation-for="StreetNumber" class="text-danger"></span>
    </div>

    <input type="hidden" asp-for="LocationLat" id="Latitude" />
    <input type="hidden" asp-for="LocationLon" id="Longitude" />

    <div class="form-group">
        <label for="Photo">Zdjęcie Schroniska</label>
        <input type="file" name="Photo" class="form-control" />
    </div>

    <h4>Wybierz Tagi</h4>
    <div class="form-group" id="tags-container">
        <select id="tags-select" class="form-control mb-2">
            <option value="">Wybierz tag</option>
            @foreach (var tag in ViewBag.Tags)
            {
                <option value="@tag.Id">@tag.Name</option>
            }
        </select>
        <button type="button" class="btn btn-secondary mb-3" onclick="addTag()">Dodaj Tag</button>
        <ul id="selected-tags-list" class="list-inline"></ul>
        <input type="hidden" name="SelectedTags" id="selected-tags" />
    </div>

    <h4>Dodaj Pokoje</h4>
    <div id="rooms-container">
        <table class="table table-bordered">
            <thead class="thead-light">
                <tr>
                    <th>Typ pokoju</th>
                    <th>Nazwa pokoju</th>
                    <th>Cena za noc</th>
                    <th>Pojemność</th>
                    <th>Udogodnienia</th>
                    <th>Usuń</th>
                </tr>
            </thead>
            <tbody id="rooms-table-body"></tbody>
        </table>
        <button type="button" class="btn btn-secondary" onclick="addRoom()">Dodaj Pokój</button>
    </div>

    <button type="submit" class="btn btn-primary mt-4">Dodaj Schronisko</button>
</form>

<script>
    const API_KEY = 'EqrphcGjSSf6pg5L1FXub1nmdOe9HzC_FV00UDqrve4';
    var lat = 52.06936257159014, lon = 19.48022053933678;

    const map = L.map('map').setView([lat, lon], 6);
    L.tileLayer(`https://api.mapy.cz/v1/maptiles/basic/256/{z}/{x}/{y}?apikey=${API_KEY}&lang=pl`, {
        minZoom: 0,
        maxZoom: 19,
        attribution: '<a href="https://api.mapy.cz/copyright" target="_blank">&copy; Seznam.cz a.s. a další</a>',
    }).addTo(map);

    let marker = L.marker([lat, lon]).addTo(map);
    document.getElementById('Latitude').value = lat;
    document.getElementById('Longitude').value = lon;

    map.on('click', function (e) {
        marker.setLatLng(e.latlng);
        document.getElementById('Latitude').value = e.latlng.lat;
        document.getElementById('Longitude').value = e.latlng.lng;
    });

    function addRoom() {
        const container = document.getElementById('rooms-table-body');
        const index = container.getElementsByTagName('tr').length;

        const row = document.createElement('tr');
        row.innerHTML = `
                <td>
                    <select name="Rooms[${index}].IdType" class="form-control">
    @foreach (var type in ViewBag.RoomTypes as List<SchroniskaTurystyczne.Models.RoomType>)
    {
                                <option value="@type.Id">@type.Name</option>
    }
                    </select>
                </td>
                <td>
                    <input type="text" name="Rooms[${index}].Name" class="form-control" />
                </td>
                <td>
                    <input type="number" step="0.01" name="Rooms[${index}].PricePerNight" class="form-control" />
                </td>
                <td>
                    <input type="number" name="Rooms[${index}].Capacity" class="form-control" />
                </td>
                <td>
                    <button type="button" class="btn btn-secondary mb-2" onclick="openFacilitiesModal(${index})">Dodaj Udogodnienia</button>
                    <div id="facilities-display-${index}" class="selected-facilities-container mt-2"></div>
                    <input type="hidden" name="Rooms[${index}].SelectedFacilities" id="selected-facilities-${index}" />
                </td>
                <td>
                    <button type="button" class="btn btn-danger" onclick="removeRoom(this)">Usuń</button>
                </td>
            `;
        container.appendChild(row);
    }

    function removeRoom(button) {
        const row = button.closest('tr');
        row.remove();
    }

    function addTag() {
        const tagSelect = document.getElementById('tags-select');
        const selectedTagsList = document.getElementById('selected-tags-list');
        const selectedTagsInput = document.getElementById('selected-tags');
        const selectedTagId = tagSelect.value;
        const selectedTagText = tagSelect.options[tagSelect.selectedIndex].text;

        if (selectedTagId && !selectedTagsInput.value.includes(selectedTagId)) {
            const tagItem = document.createElement('li');
            tagItem.className = "badge badge-info m-1";
            tagItem.textContent = selectedTagText;
            tagItem.dataset.tagId = selectedTagId;

            const removeButton = document.createElement('button');
            removeButton.textContent = "×";
            removeButton.type = "button";
            removeButton.classList.add('btn', 'btn-link', 'p-0', 'ml-2', 'text-white');
            removeButton.onclick = function () {
                tagItem.remove();
                updateSelectedTags();
            };
            tagItem.appendChild(removeButton);
            selectedTagsList.appendChild(tagItem);
            updateSelectedTags();
        }
    }

    function updateSelectedTags() {
        const selectedTagsList = document.getElementById('selected-tags-list');
        const selectedTags = Array.from(selectedTagsList.children).map(tagItem => tagItem.dataset.tagId);
        document.getElementById('selected-tags').value = selectedTags.join(',');
    }

    let currentRoomIndex = null;

    function openFacilitiesModal(roomIndex) {
        currentRoomIndex = roomIndex;
        document.querySelectorAll('#facilities-list input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = document.getElementById(`selected-facilities-${roomIndex}`).value.includes(checkbox.value);
        });
        document.getElementById('facilities-modal').style.display = 'block';
        document.getElementById('modal-overlay').style.display = 'block';
    }

    function closeFacilitiesModal() {
        document.getElementById('facilities-modal').style.display = 'none';
        document.getElementById('modal-overlay').style.display = 'none';
        currentRoomIndex = null;
    }

    function toggleFacility(checkbox, facilityName) {
        const selectedFacilitiesInput = document.getElementById(`selected-facilities-${currentRoomIndex}`);
        let selectedFacilities = selectedFacilitiesInput ? selectedFacilitiesInput.value.split(',') : [];

        if (checkbox.checked) {
            selectedFacilities.push(checkbox.value);
        } else {
            selectedFacilities = selectedFacilities.filter(id => id !== checkbox.value);
        }

        selectedFacilitiesInput.value = selectedFacilities.join(',');
        updateFacilitiesListDisplay(currentRoomIndex, facilityName, checkbox.checked);
    }

    function updateFacilitiesListDisplay(roomIndex, facilityName, add) {
        const displayElement = document.getElementById(`facilities-display-${roomIndex}`);
        const facilityItem = document.createElement('span');
        facilityItem.className = 'badge badge-info m-1';
        facilityItem.innerText = facilityName;

        if (add) {
            displayElement.appendChild(facilityItem);
        } else {
            [...displayElement.children].forEach(child => {
                if (child.innerText === facilityName) child.remove();
            });
        }
    }
</script>

<!-- Modal Udogodnień -->
<div id="facilities-modal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: white; border: 1px solid #ddd; border-radius: 10px; padding: 20px; z-index: 1000; width: 300px;">
    <h4>Wybierz Udogodnienia</h4>
    <ul id="facilities-list">
        @foreach (var facility in ViewBag.Facilities as List<SchroniskaTurystyczne.Models.Facility>)
        {
            <li>
                <label>
                    <input type="checkbox" value="@facility.Id" onclick="toggleFacility(this, '@facility.Name')" />
                    @facility.Name
                </label>
            </li>
        }
    </ul>
    <button type="button" class="btn btn-primary mt-3" onclick="closeFacilitiesModal()">Zamknij</button>
</div>
<div id="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 999;"></div>